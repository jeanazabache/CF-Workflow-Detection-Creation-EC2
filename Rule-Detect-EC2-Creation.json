{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "CloudFormation template for EventBridge RuleDetectEC2Creation",
  "Resources": {
    "Ruled4e2ae0b": {
      "Type": "AWS::Events::Rule",
      "Properties": {
        "Name": "DetectEC2Creation",
        "EventPattern": "{\"source\":[\"aws.ec2\"],\"detail-type\":[\"AWS API Call via CloudTrail\"],\"detail\":{\"eventSource\":[\"ec2.amazonaws.com\"],\"eventName\":[\"RunInstances\"],\"userIdentity\":{\"sessionContext\":{\"sessionIssuer\":{\"userName\":[{\"anything-but\":[\"aws-batch\",\"AWSServiceRoleForBatch\"]}]}}}}}",
        "State": "ENABLED",
        "Description": "NotificaciÃ³n automÃ¡tica que se activa cuando se detecta la creaciÃ³n de nuevas instancias en AWS. Esta alerta permite monitorear y auditar la infraestructura en tiempo real, asegurando control y seguridad en los despliegues.",
        "EventBusName": "default",
        "Targets": [{
          "Id": "Idb0f8b83f-269a-41d0-b44d-e2eaaa8691b1",
          "Arn": {
            "Fn::Sub": "arn:${AWS::Partition}:sns:${AWS::Region}:${AWS::AccountId}:utp-prd-notification-instance-creation-topic"
          },
          "InputTransformer": {
            "InputPathsMap": {
              "accountId": "$.account",
              "arn": "$.detail.userIdentity.arn",
              "availabilityZone": "$.detail.responseElements.instancesSet.items[0].placement.availabilityZone",
              "eventTime": "$.detail.eventTime",
              "imageId": "$.detail.responseElements.instancesSet.items[0].imageId",
              "instanceId": "$.detail.responseElements.instancesSet.items[0].instanceId",
              "instanceType": "$.detail.responseElements.instancesSet.items[0].instanceType",
              "launchTime": "$.detail.responseElements.instancesSet.items[0].launchTime",
              "principalId": "$.detail.userIdentity.principalId",
              "privateIpAddress": "$.detail.responseElements.instancesSet.items[0].privateIpAddress",
              "securityGroupId": "$.detail.responseElements.instancesSet.items[0].groupSet.items[0].groupId",
              "securityGroupName": "$.detail.responseElements.instancesSet.items[0].groupSet.items[0].groupName",
              "sourceIPAddress": "$.detail.sourceIPAddress",
              "subnetId": "$.detail.responseElements.instancesSet.items[0].subnetId",
              "userName": "$.detail.userIdentity.sessionContext.sessionIssuer.userName",
              "vpcId": "$.detail.responseElements.instancesSet.items[0].vpcId"
            },
            "InputTemplate": "{\n  \"ğŸš¨ğŸš¨ event\": \"CreaciÃ³n de Instancia - EC2 ğŸš¨ğŸš¨\",\n  \"âš™ï¸ accountId\": \"<accountId>\",\n  \"instanceDetails\": {\n    \"ğŸ†” instanceId\": \"<instanceId>\",\n    \"ğŸ“· amiId\": \"<imageId>\",\n    \"âš™ï¸ instanceType\": \"<instanceType>\",\n    \"â³ launchTime\": \"<launchTime>\",\n    \"ğŸš€ subnetId\": \"<subnetId>\",\n    \"ğŸ¢ vpcId\": \"<vpcId>\"\n  },\n  \"user\": {\n    \"ğŸ“Œ userName\": \"<userName>\",\n    \"ğŸ‘¨â€ğŸ’» principalId\": \"<principalId>\",\n    \"âš¡ arn\": \"<arn>\",\n    \"ğŸŒ sourceIPAddress\": \"<sourceIPAddress>\"\n  },\n  \"ğŸ“† eventTime\": \"<eventTime>\"\n}"
          }
        }]
      }
    }
  },
  "Parameters": {}
}